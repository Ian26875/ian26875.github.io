{"title":"CoreProfile 實現跨應用程式性能調整及監控","slug":"coreprofile實現跨服務追蹤","date":"2022-12-16T14:53:48.000Z","updated":"2023-01-02T04:53:36.206Z","comments":true,"path":"api/articles/coreprofile實現跨服務追蹤.json","photos":[],"link":"","excerpt":null,"covers":null,"content":"<h2 id=\"適用情境\"><a href=\"#適用情境\" class=\"headerlink\" title=\"適用情境:\"></a>適用情境:</h2><ul>\n<li>當橫跨API服務應用程式之間請求與回應效能低下，需要API服務性能調教及追蹤效能。</li>\n</ul>\n<h2 id=\"NuGet套件\"><a href=\"#NuGet套件\" class=\"headerlink\" title=\"NuGet套件:\"></a>NuGet套件:</h2><figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">Install-Package</span> CoreProfiler</span><br><span class=\"line\"><span class=\"built_in\">Install-Package</span> CoreProfiler.Web</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"環境要求\"><a href=\"#環境要求\" class=\"headerlink\" title=\"環境要求:\"></a>環境要求:</h2><ul>\n<li><p>WebService應用程式須安裝CoreProfile或NanoProfile，且DrillDown功能須設定為開啟，允許從外部應用程序向下鑽取子請求。</p>\n</li>\n<li><p>Net.Core專案 Startup.cs 必須加上 app.UseCoreProfiler(true)。 (參數為true表示開啟跨應用程式，從外部應用程序向下取子請求drillDown功能)</p>\n</li>\n</ul>\n<figure class=\"highlight c#\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Configure</span>(<span class=\"params\">IApplicationBuilder app, IWebHostEnvironment env</span>)</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    app.UseCoreProfiler(<span class=\"literal\">true</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (env.IsDevelopment())</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        app.UseDeveloperExceptionPage();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    app.UseHttpsRedirection();</span><br><span class=\"line\"></span><br><span class=\"line\">    app.UseRouting();</span><br><span class=\"line\"></span><br><span class=\"line\">    app.UseAuthorization();</span><br><span class=\"line\"></span><br><span class=\"line\">    app.UseEndpoints(endpoints =&gt;</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        endpoints.MapControllers();</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"實作內容\"><a href=\"#實作內容\" class=\"headerlink\" title=\"實作內容:\"></a>實作內容:</h2><hr>\n<h3 id=\"方法一-ProfilingSession-Current-WebTimingAsync\"><a href=\"#方法一-ProfilingSession-Current-WebTimingAsync\" class=\"headerlink\" title=\"方法一 :  ProfilingSession.Current.WebTimingAsync\"></a>方法一 :  ProfilingSession.Current.WebTimingAsync</h3><figure class=\"highlight c#\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// WebTimingAsync() profiles the wrapped action as a web request timing</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> url = <span class=\"keyword\">this</span>.Request.Scheme + <span class=\"string\">&quot;://&quot;</span> + <span class=\"keyword\">this</span>.Request.Host + <span class=\"string\">&quot;/home/child&quot;</span>;</span><br><span class=\"line\"><span class=\"keyword\">await</span> ProfilingSession.Current.WebTimingAsync(url, <span class=\"keyword\">async</span> (correlationId) =&gt;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">using</span> (<span class=\"keyword\">var</span> httpClient = <span class=\"keyword\">new</span> HttpClient())</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        httpClient.DefaultRequestHeaders.Add(CoreProfilerMiddleware.XCorrelationId, correlationId);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> uri = <span class=\"keyword\">new</span> Uri(url);</span><br><span class=\"line\">        <span class=\"keyword\">var</span> result = <span class=\"keyword\">await</span> httpClient.GetStringAsync(uri);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n\n<ul>\n<li><p>HttpClient發送前，必需要在HttpHeader加上CorrelationId，才能取得外部應用程式CoreProfiler或NanoProfiler的監控紀錄。</p>\n</li>\n<li><p>HttpClient都需要加上以上的程式碼，會過於繁重，個人比較推薦使用第二種方法，亦可使用設定的方式進行移除或裝載功能。</p>\n</li>\n</ul>\n<hr>\n<h3 id=\"方法二-HttpClientFactory-實作-DelegatingHandler\"><a href=\"#方法二-HttpClientFactory-實作-DelegatingHandler\" class=\"headerlink\" title=\"方法二 : HttpClientFactory 實作 DelegatingHandler\"></a>方法二 : HttpClientFactory 實作 DelegatingHandler</h3><p>CoreProfilerDelegatingHandler.cs</p>\n<figure class=\"highlight c#\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">CoreProfilerDelegatingHandler</span> : <span class=\"title\">DelegatingHandler</span></span><br><span class=\"line\">&#123;   </span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">override</span> <span class=\"keyword\">async</span> Task&lt;HttpResponseMessage&gt; <span class=\"title\">SendAsync</span>(<span class=\"params\">HttpRequestMessage request, CancellationToken cancellationToken</span>)</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (ProfilingSession.Current == <span class=\"literal\">null</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">await</span> <span class=\"keyword\">base</span>.SendAsync(request, cancellationToken);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"built_in\">string</span> url = request.RequestUri.AbsoluteUri;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">var</span> webTiming = <span class=\"keyword\">new</span> WebTiming</span><br><span class=\"line\">        (</span><br><span class=\"line\">            profiler: ProfilingSession.Current.Profiler, </span><br><span class=\"line\">            url: url</span><br><span class=\"line\">        );</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"keyword\">try</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            request.Headers.Add</span><br><span class=\"line\">            (</span><br><span class=\"line\">                CoreProfilerMiddleware.XCorrelationId,</span><br><span class=\"line\">                webTiming.CorrelationId</span><br><span class=\"line\">            );</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">await</span> <span class=\"keyword\">base</span>.SendAsync(request, cancellationToken);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">finally</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            webTiming.Stop();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n<p>   ~&#x2F;Startup.cs</p>\n<figure class=\"highlight c#\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title\">Startup</span></span><br><span class=\"line\">  &#123;</span><br><span class=\"line\">      <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">Startup</span>(<span class=\"params\">IConfiguration configuration</span>)</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">          Configuration = configuration;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">public</span> IConfiguration Configuration &#123; <span class=\"keyword\">get</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// This method gets called by the runtime. Use this method to add services to the container.</span></span><br><span class=\"line\">      <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">ConfigureServices</span>(<span class=\"params\">IServiceCollection services</span>)</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">          <span class=\"comment\">//HttpClient 註冊可以用給予名稱進行設定</span></span><br><span class=\"line\">         services.AddTransient&lt;CoreProfilerDelegatingHandler&gt;()</span><br><span class=\"line\">                  .AddHttpClient(<span class=\"string\">&quot;Tracing&quot;</span>)</span><br><span class=\"line\">                  .AddHttpMessageHandler&lt;CoreProfilerDelegatingHandler&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">          services.AddControllers();</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">     </span><br><span class=\"line\">      <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">Configure</span>(<span class=\"params\">IApplicationBuilder app, IWebHostEnvironment env</span>)</span></span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">          <span class=\"comment\">// 記得一定是ture</span></span><br><span class=\"line\">          app.UseCoreProfiler(<span class=\"literal\">true</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">          <span class=\"keyword\">if</span> (env.IsDevelopment())</span><br><span class=\"line\">          &#123;</span><br><span class=\"line\">              app.UseDeveloperExceptionPage();</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">         </span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>使用HttpClientFactory已註冊過使用的name，已經註冊的HttpClient已加入CoreProfilerDelegatingHandler。</li>\n</ul>\n<figure class=\"highlight c#\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//必須要跟註冊的HttpClient的名稱一樣</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> httpClient = <span class=\"keyword\">this</span>._httpClientFactory.CreateClient(<span class=\"string\">&quot;Tracing&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">var</span> response = <span class=\"keyword\">await</span> httpClient.GetAsync(url).ConfigureAwait(<span class=\"literal\">false</span>);</span><br><span class=\"line\"> </span><br></pre></td></tr></table></figure>\n\n\n\n\n<h2 id=\"參考資料\"><a href=\"#參考資料\" class=\"headerlink\" title=\"參考資料:\"></a>參考資料:</h2><p>HttpClientFactory:</p>\n<ul>\n<li><a href=\"https://docs.microsoft.com/zh-tw/aspnet/core/fundamentals/http-requests?view=aspnetcore-3.1\">https://docs.microsoft.com/zh-tw/aspnet/core/fundamentals/http-requests?view=aspnetcore-3.1</a></li>\n</ul>\n<p>CoreProfiler:</p>\n<ul>\n<li><a href=\"https://github.com/teddymacn/CoreProfiler\">https://github.com/teddymacn/CoreProfiler</a></li>\n<li><a href=\"https://github.com/teddymacn/cross-app-profiling-demo\">https://github.com/teddymacn/cross-app-profiling-demo</a></li>\n<li><a href=\"https://www.itread01.com/articles/1475204636.html\">https://www.itread01.com/articles/1475204636.html</a></li>\n</ul>\n","categories":[{"name":".Net Core","slug":"Net-Core","count":2,"path":"api/categories/Net-Core.json"},{"name":"監控","slug":"Net-Core/監控","count":1,"path":"api/categories/Net-Core/監控.json"}],"tags":[{"name":".Net Core","slug":"Net-Core","count":2,"path":"api/tags/Net-Core.json"},{"name":"2022","slug":"2022","count":2,"path":"api/tags/2022.json"},{"name":"監控","slug":"監控","count":1,"path":"api/tags/監控.json"}]}